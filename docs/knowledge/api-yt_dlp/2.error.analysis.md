# Exception Scenario Analysis Results

## Raw yt-dlp API Results

**Test Method:** Independent script tests raw yt-dlp API calls to capture unmodified exception behavior. For example `uv run scripts/temp_raw_yt_dlp.py <url_here>`

### Scenario 1: Empty URL (`""`)
- **Raw Exception**: `DownloadError: ERROR: [generic] '' is not a valid URL`
- **Exception Type**: `yt_dlp.utils.DownloadError`

### Scenario 2: Incomplete URL (`"https://www.youtube.com/watch?v=Q4g"`)
- **Raw Exception**: `DownloadError: ERROR: [youtube:truncated_id] Q4g: Incomplete YouTube ID Q4g. URL https://www.youtube.com/watch?v=Q4g looks truncated.`
- **Exception Type**: `yt_dlp.utils.DownloadError`

### Scenario 3: Non-YouTube URL (`"https://www.google.com/"`)
- **Raw Exception**: `DownloadError: ERROR: Unsupported URL: https://www.google.com/`
- **Exception Type**: `yt_dlp.utils.DownloadError`

### Scenario 4: Malformed URL (`"not_a_url_at_all"`)
- **Raw Exception**: `DownloadError: ERROR: [generic] 'not_a_url_at_all' is not a valid URL`
- **Exception Type**: `yt_dlp.utils.DownloadError`

### Scenario 5: Unavailable Video (`"https://youtu.be/ai_HGCf2w_w"`)
- **Raw Exception**: `DownloadError: ERROR: [youtube] ai_HGCf2w_w: Video unavailable. This video has been removed by the uploader`
- **Exception Type**: `yt_dlp.utils.DownloadError`

### Scenario 6: Bot Protection (intermitant! `"https://www.youtube.com/watch?v=Q4gsvJvRjCU"`)
- **Raw Exception**: `DownloadError: ERROR: [youtube] Q4gsvJvRjCU: Sign in to confirm you're not a bot. Use --cookies-from-browser or --cookies for the authentication.`
- **Exception Type**: `yt_dlp.utils.DownloadError`

### Scenario 7: No Transcript Available (`"https://www.youtube.com/watch?v=6eBSHbLKuN0"`)
- **Raw Exception**: No exception during `extract_info()` - metadata extraction succeeds
- **Exception Type**: `youtube_to_xml.exceptions.URLSubtitlesNotFoundError` (raised by script logic)
- **Note**: yt-dlp successfully extracts metadata, but no subtitles/captions are available

### Scenario 8: Private Video (`"https://youtu.be/15vClfaR35w"`)
- **Raw Exception**: `DownloadError: ERROR: [youtube] 15vClfaR35w: Private video. Sign in if you've been granted access to this video. Use --cookies-from-browser or --cookies for the authentication. See  https://github.com/yt-dlp/yt-dlp/wiki/FAQ#how-do-i-pass-cookies-to-yt-dlp  for how to manually pass cookies. Also see  https://github.com/yt-dlp/yt-dlp/wiki/Extractors#exporting-youtube-cookies  for tips on effectively exporting YouTube cookies`
- **Exception Type**: `yt_dlp.utils.DownloadError`

## Script Results

**Test Method:** `uv run scripts/url_to_transcript.py "<url_input>"` with exception mapping applied.

### Scenario 1: Empty URL (`""`)
- **Script Exception**: `URLIsInvalidError: Invalid URL format`
- **User Message**: `❌ Error: Invalid URL format`
- **✅ Mapping Result**: ✅ Correctly mapped

### Scenario 2: Incomplete URL (`"https://www.youtube.com/watch?v=Q4g"`)
- **Script Exception**: `URLIncompleteError: YouTube URL is incomplete`
- **User Message**: `❌ Error: YouTube URL is incomplete`
- **✅ Mapping Result**: ✅ Correctly mapped

### Scenario 3: Non-YouTube URL (`"https://www.google.com/"`)
- **Script Exception**: `URLNotYouTubeError: URL is not a YouTube video`
- **User Message**: `❌ Error: URL is not a YouTube video`
- **✅ Mapping Result**: ✅ Correctly mapped

### Scenario 4: Malformed URL (`"not_a_url_at_all"`)
- **Script Exception**: `URLIsInvalidError: Invalid URL format`
- **User Message**: `❌ Error: Invalid URL format`
- **✅ Mapping Result**: ✅ Correctly mapped

### Scenario 5: Unavailable Video (`"https://youtu.be/ai_HGCf2w_w"`)
- **Script Exception**: `URLVideoUnavailableError: YouTube video unavailable`
- **User Message**: `❌ Error: YouTube video unavailable`
- **✅ Mapping Result**: ✅ Correctly mapped

### Scenario 6: Bot Protection (intermitant! `"https://www.youtube.com/watch?v=Q4gsvJvRjCU"`)
- **Script Exception**: `URLBotProtectionError: YouTube requires verification`
- **User Message**: `❌ Error: YouTube requires verification - try switching networks`
- **✅ Mapping Result**: ✅ Correctly mapped

### Scenario 7: No Transcript Available (`"https://www.youtube.com/watch?v=6eBSHbLKuN0"`)
- **Script Exception**: `URLSubtitlesNotFoundError: This video doesn't have subtitles available`
- **User Message**: `❌ Error: This video doesn't have subtitles available`
- **✅ Mapping Result**: ✅ Correctly handled (not a yt-dlp mapping - script logic)

### Scenario 8: Private Video (`"https://youtu.be/15vClfaR35w"`)
- **Script Exception**: `URLUnknownUnmappedError: [youtube] 15vClfaR35w: Private video. Sign in if you've been granted access to this video. Use --cookies-from-browser or --cookies for the authentication. See  https://github.com/yt-dlp/yt-dlp/wiki/FAQ#how-do-i-pass-cookies-to-yt-dlp  for how to manually pass cookies. Also see  https://github.com/yt-dlp/yt-dlp/wiki/Extractors#exporting-youtube-cookies  for tips on effectively exporting YouTube cookies`
- **User Message**: `❌ Error: [youtube] 15vClfaR35w: Private video. Sign in if you've been granted access to this video. Use --cookies-from-browser or --cookies for the authentication. See  https://github.com/yt-dlp/yt-dlp/wiki/FAQ#how-do-i-pass-cookies-to-yt-dlp  for how to manually pass cookies. Also see  https://github.com/yt-dlp/yt-dlp/wiki/Extractors#exporting-youtube-cookies  for tips on effectively exporting YouTube cookies`
- **✅ Mapping Result**: ✅ Correctly handled - fallback preserves yt-dlp's informative message

## Comparison and Insights

### Key Finding 1: All yt-dlp errors become DownloadError
**Raw yt-dlp API behavior**: All scenarios result in `yt_dlp.utils.DownloadError` with different error messages. The exception type is always the same, only the message varies.

### Key Finding 2: Exception mapping works well with fallback
**Script behavior**: The mapping function correctly distinguishes between common error types based on the message content and maps them to appropriate custom exceptions. For unmapped scenarios like private videos (Scenario 8), the system gracefully falls back to `URLUnknownUnmappedError` which preserves yt-dlp's original message after cleaning (removes "ERROR: " prefix).

### Key Finding 3: No null metadata observed
**Critical insight**: In all test scenarios, `ydl.extract_info()` raises an exception **before returning any value**. None of the tested scenarios returned `None` or falsy metadata.

### Key Finding 4: Message patterns are reliable with robust fallback
The mapping relies on these patterns in yt-dlp error messages:
- `"is not a valid url"` → `URLIsInvalidError`
- `"incomplete youtube id"` → `URLIncompleteError` 
- `"unsupported url"` → `URLNotYouTubeError`
- `"video unavailable"` → `URLVideoUnavailableError`
- `"sign in to confirm you're not a bot"` → `URLBotProtectionError`
- `"private video"` → Uses fallback `URLUnknownUnmappedError` (preserves yt-dlp's cleaned message)

### Key Finding 5: No transcript scenario is different
**Unique behavior**: The no-transcript scenario (Scenario 7) doesn't trigger yt-dlp exceptions during `extract_info()`. Instead, metadata extraction succeeds, but the script logic detects missing subtitle files and raises `URLSubtitlesNotFoundError`.

## Exception Mapping Analysis

### Current Mapping in `src/youtube_to_xml/exceptions.py`:
```python
error_patterns = [
    ("429", URLRateLimitError),
    ("sign in to confirm you're not a bot", URLBotProtectionError),
    ("unsupported url", URLNotYouTubeError),
    ("incomplete youtube id", URLIncompleteError),
    ("is not a valid url", URLIsInvalidError),
    ("[youtube] invalid-url:", URLIsInvalidError),
    ("video unavailable", URLVideoUnavailableError),
]
```

### ✅ Mapping is Comprehensive and Robust
- **Common yt-dlp exception scenarios** (1-6) are covered by the mapping
- **Pattern matching** is case-insensitive and works reliably for covered scenarios
- **Exception types** match the semantic meaning of each error
- **Robust fallback** to `URLUnknownUnmappedError` handles edge cases like private videos (Scenario 8)
- **Script logic handling** correctly manages no-transcript scenario (7)
- **Message cleaning**: The fallback removes "ERROR: " prefix while preserving yt-dlp's informative messages

### System Analysis Summary
The exception mapping system is working as designed:
- **Core scenarios** are mapped to user-friendly exception types with concise messages
- **Edge cases** like private videos gracefully fall back to `URLUnknownUnmappedError`
- **Fallback behavior** preserves yt-dlp's detailed error messages (with prefix cleanup)
- **Design rationale**: Rather than mapping every possible yt-dlp error, the system maps common cases and relies on yt-dlp's own messaging for edge cases