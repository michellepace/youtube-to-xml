# PR 4: CLI Dual Interface with Legacy Flag - Implementation Plan

## Goal
Add a `--legacy` flag to the CLI that allows users to choose between the legacy parser path (current default) and the new TranscriptDocument-based parser path. This provides a safe migration path where users can verify both paths produce identical output before legacy removal in PR 5.

## Current State (PRs 1-3 completed)
- ✅ `models.py` with TranscriptDocument, VideoMetadata, Chapter, TranscriptLine
- ✅ `xml_builder.py` with both `chapters_to_xml()` and `transcript_to_xml()` functions
- ✅ `file_parser.py` with both `parse_transcript_file()` and `parse_transcript_document()` functions
- ✅ CLI uses only legacy path (`parse_transcript_file` → `chapters_to_xml`)

## TDD Implementation Steps

### Step 1: Write failing tests for --legacy flag functionality
1. Add test in `tests/test_cli.py` for default (new) path behavior
2. Add test for `--legacy` flag preserving old behavior
3. Run tests to confirm they fail (no --legacy flag exists yet)

### Step 2: Implement --legacy flag in CLI argument parser
1. Modify `cli.py:parse_arguments()` to add `--legacy` flag (lines 39-46)
2. Add import for `parse_transcript_document` and `transcript_to_xml`
3. Run tests - should still fail (flag exists but not used)

### Step 3: Implement dual-path logic
1. Update `cli.py:main()` to check `args.legacy` flag (lines 77-89)
2. If `--legacy`: use `parse_transcript_file()` → `chapters_to_xml()`
3. If not `--legacy`: use `parse_transcript_document()` → `transcript_to_xml()`
4. Add logging to indicate which path was used
5. Run tests - should now pass

### Step 4: Add comprehensive test coverage
1. Create parametrized tests in `tests/test_cli.py`:
   - Test both paths with valid transcript
   - Test both paths with empty file
   - Test both paths with invalid format
   - Verify both produce same exit codes and similar messages
2. Run tests, fix any issues

### Step 5: Add end-to-end comparison tests
1. Update `tests/test_end_to_end.py`:
   - Modify `run_script()` helper to support `--legacy` flag
   - Create mirror tests for existing file tests with `--legacy` flag
   - Add comparison test that runs both paths and verifies identical XML output
2. Use existing fixtures: `x4-chapters.txt`, `x3-chapters-with-blanks.txt`, etc.

### Step 6: Create comprehensive verification script
1. Create temporary script `verify_dual_path_alignment.py`:
   - Iterate through all example_transcripts/*.txt files
   - Run CLI with and without `--legacy` flag
   - Parse and compare XML outputs
   - Generate summary report of matches/deviations
2. Run verification to ensure 100% alignment

### Step 7: Code quality checks
1. Run `uv run ruff check --fix` and fix any issues
2. Run `uv run ruff format` to ensure consistent formatting
3. Run `uv run pytest` to verify all tests pass
4. Run `uv run pytest -v tests/test_cli.py` for focused testing
5. Run `uv run pytest -v tests/test_end_to_end.py` for integration tests

## Expected File Changes

**Modified Files:**
- `src/youtube_to_xml/cli.py`:
  - Add `--legacy` flag to argument parser
  - Add imports for new functions
  - Add dual-path logic based on flag
  - Update logging messages

- `tests/test_cli.py`:
  - Add tests for new default path
  - Add tests for `--legacy` flag
  - Parametrize existing tests to run both paths

- `tests/test_end_to_end.py`:
  - Update helper functions to support `--legacy`
  - Mirror existing tests with legacy flag
  - Add XML comparison tests

**New Files:**
- `verify_dual_path_alignment.py` (temporary, not committed):
  - Comprehensive comparison script
  - Will be deleted after verification

## Success Criteria
- [ ] All existing tests pass unchanged
- [ ] New tests verify both paths work correctly
- [ ] `--legacy` flag preserves exact current behavior
- [ ] Default (no flag) uses new TranscriptDocument path
- [ ] Both paths produce identical XML output for all test files
- [ ] Verification script confirms 100% alignment
- [ ] Code passes all ruff checks
- [ ] Clear logging indicates which path was used

## Risk Mitigation
- **Very Low Risk**: Changes are purely additive
- Legacy path remains completely unchanged
- Users can explicitly use `--legacy` if issues arise
- Comprehensive testing ensures no regression
- Verification script provides confidence before PR 5 removes legacy code

## Progress Tracking
- [ ] Write failing tests for --legacy flag functionality
- [ ] Implement --legacy flag in CLI argument parser
- [ ] Implement dual-path logic in cli.py main function
- [ ] Add comprehensive test coverage for both paths
- [ ] Add end-to-end comparison tests
- [ ] Create comprehensive verification script
- [ ] Run code quality checks and fix issues