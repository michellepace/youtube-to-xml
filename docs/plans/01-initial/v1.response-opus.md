# First Deliverable Plan: Core Transcript to XML Conversion

## 1. Scope - Smallest Working Piece

Build the core functionality that can convert a single transcript file to XML:

- Parse transcript to detect chapters using proven regex from `transcript_reporter.py`
- Extract chapter content (extending the Chapter dataclass)
- Generate XML following the exact template from SPEC
- Basic CLI with argparse for file input
- Minimal but clear error handling

## 2. Module Architecture (One Module, One Purpose)

```text
src/youtube_to_xml/
src/youtube_to_xml/
├── __init__.py      # Main orchestrator: CLI → parse → XML → save
├── parser.py        # Phase transform: delete chapters with content  
├── xml_generator.py # Convert Chapter objects to XML ElementTree
└── cli.py           # Argparse setup and error handling
```

## 3. TDD Implementation Order

1. **Test & Implement `parser.py`** first:
   - Test timestamp detection with TIMESTAMP_PATTERN regex
   - Test chapter detection (Rule 1: first line, Rule 2: 2 lines between timestamps)
   - Test content extraction for each chapter
   - Extend Chapter dataclass to include `content_lines: list[str]`

2. **Test & Implement `xml_generator.py`**:
   - Test XML structure matches template exactly
   - Test special character escaping (&, <, >, ", ')
   - Test ElementTree API usage with proper formatting

3. **Test & Implement `cli.py`**:
   - Test argparse help message matches SPEC
   - Test file validation (exists, not empty, valid format)
   - Test output directory creation

4. **Integration in `__init__.py`**:
   - Wire together: parse → generate → save
   - Test end-to-end with sample transcript

## 4. Manual Verification Commands

```bash
# Test with existing sample
uv run youtube-to-xml transcript_files/learn-nextjs-7mins.txt

# Verify XML output is created
ls transcript_files/learn-nextjs-7mins.xml

# Validate XML structure
uv run python -c "import xml.etree.ElementTree as ET; ET.parse('transcript_files/learn-nextjs-7mins.xml'); print('→ Valid XML')"

# View formatted XML
cat transcript_files/learn-nextjs-7mins.xml

# Run all tests
uv run python -m pytest -v

# Check code quality
uv run ruff check
uv run ruff format --check
```

## 5. Key Implementation Details from Reference Code

- Use `TIMESTAMP_PATTERN = re.compile(r"^\d{1,2}:\d{2}(:\d{2})?$")`
- Adapt `find_chapters()` logic but include content extraction
- Use ElementTree API: `ET.Element()`, `ET.SubElement()`, `ET.indent()`
- Output to `transcript_files/` directory (create if needed)

This delivers a working converter that demonstrates all core functionality while keeping the scope focused and testable.
